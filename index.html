<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Analyzer</title>
  <style>
    :root {
      --bg1: #6a11cb;
      --bg2: #2575fc;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --ok: #16a34a;
      --warn: #dc2626;
      --chip: #eef2ff;
      --border: #e5e7eb;
      --shadow: 0 8px 30px rgba(0,0,0,.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg2)) fixed;
      min-height: 100vh;
    }
    .container { max-width: 1060px; margin: 32px auto; padding: 0 16px; }

    /* Header */
    .header { background: #fff; border-radius: 16px; padding: 18px 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; }
    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 2px 0 0; color: var(--muted); }

    /* Scoring explainer */
    .explain { margin-top: 16px; background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; border-radius: 14px; padding: 16px; }
    .explain h3 { margin: 0 0 8px; font-size: 16px; }
    .explain .grid { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 10px; }
    .tile { background: #fff; border-radius: 10px; padding: 10px; border: 1px solid #fde68a; }

    /* Controls */
    .controls {
      margin-top: 18px; background: #fff; border-radius:16px; padding:16px; box-shadow: var(--shadow);
      display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items:end;
    }
    .form-group { grid-column: span 3; }
    .form-group.rehab { grid-column: span 3; }
    .form-label { display:block; font-size: 12px; color: #334155; margin-bottom: 6px; }
    .form-input { width: 100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; }
    .form-hint { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .switches { grid-column: span 4; display:flex; gap:16px; align-items:center; }
    .switches label { display:flex; gap:8px; align-items:center; font-size: 14px; color:#334155; }
    .actions { grid-column: span 2; justify-self:end; }
    #analyzeBtn { width: 100%; background:#4f46e5; color:#fff; border:none; border-radius:12px; padding:12px 14px; font-weight:600; cursor:pointer; }
    #analyzeBtn:disabled { opacity:.6; cursor:not-allowed; }

    /* Banners & Loading */
    .banner { margin-top:16px; padding:14px; border-radius:14px; background:#fff; }
    .loading { display:flex; gap:12px; align-items:center; }
    .spinner { width:18px; height:18px; border:3px solid #e5e7eb; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Summary */
    .summary { margin-top:18px; display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; }
    .summary-item { background:#ffffff; border-radius:12px; padding:12px; box-shadow: var(--shadow); text-align:center;}
    .summary-label { color:var(--muted); font-size:12px; }
    .summary-value { font-size:18px; font-weight:700; margin-top:4px; }

    /* Results grid */
    .results { margin-top:14px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; }
    .tract-card { position:relative; background:#ffffff; border-radius:16px; padding:14px; box-shadow: var(--shadow); }
    .score-badge { position:absolute; top:-10px; right:-10px; width:62px; height:62px; border-radius:50%; background:#e5e7eb; color:#111827; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:800; }
    .score-badge .score-label { font-weight:700; font-size:10px; margin-top:2px; }
    .score-badge.excellent { background:#dcfce7; }
    .score-badge.very-good { background:#e0f2fe; }
    .score-badge.good { background:#fef9c3; }
    .score-badge.fair { background:#fee2e2; }

    .tract-title { font-weight:800; font-size:18px; padding-right:74px; }
    .tract-sub { color:var(--muted); font-size:12px; margin-top:4px; }

    .chips { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .chip-gap, .chip-zip, .chip-hint { background:var(--chip); color:#3730a3; border-radius:999px; padding:4px 8px; font-size:12px; border:1px solid #e0e7ff; }
    .chip-gap.excellent { background:#dcfce7; color:#065f46; border-color:#bbf7d0; }
    .chip-gap.warning { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }

    .tract-info { margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:14px; }
    .info-row { display:flex; justify-content:space-between; }
    .info-label { color:#475569; }
    .info-value { font-weight:700; }

    /* Collapsible blocks */
    details.block { border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; margin-top:10px; }
    details.block + details.block { margin-top:8px; }
    details.block > summary { list-style:none; cursor:pointer; font-weight:700; }
    details.block > summary::-webkit-details-marker { display:none; }
    details.block[open] > summary { color:#4f46e5; }
    details .content { margin-top:8px; font-size:14px; }
    details .bullets { padding-left:18px; margin:8px 0 0; }

    .error { background:#fff1f2; border:1px solid #fecdd3; color:#7f1d1d; border-radius:12px; padding:14px; }
    .empty { background:#ffffff; border-radius:12px; padding:16px; text-align:center; }

    @media (max-width: 900px) {
      .summary { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .results { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
      .form-group, .form-group.rehab, .switches, .actions { grid-column: 1 / -1; }
      .actions { justify-self: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="font-size:28px">üè†</div>
      <div>
        <h1>Flip Analyzer</h1>
        <p>Find the best neighborhoods for flipping houses in Central Indiana</p>
      </div>
    </div>

    <div class="explain">
      <h3>üü° How Areas Are Scored (0‚Äì100 points)</h3>
      <div class="grid">
        <div class="tile"><strong>Buy-Sell Gap (40%)</strong><br/>Best when median value is ~1.3‚Äì1.4√ó your max purchase price.</div>
        <div class="tile"><strong>Vacancy Rate (25%)</strong><br/>8‚Äì15% suggests healthy inventory without distress.</div>
        <div class="tile"><strong>Buyer Income (25%)</strong><br/>Buyers need ~3‚Äì4√ó income vs. home value.</div>
        <div class="tile"><strong>Market Speed (10%)</strong><br/>Lower DOM = stronger demand.</div>
      </div>
    </div>

    <div class="controls">
      <div class="form-group">
        <label for="minPrice" class="form-label">Min Purchase Price</label>
        <input id="minPrice" class="form-input" type="number" value="200000" step="5000" />
      </div>
      <div class="form-group">
        <label for="maxPrice" class="form-label">Max Purchase Price</label>
        <input id="maxPrice" class="form-input" type="number" value="225000" step="5000" />
      </div>
      <div class="form-group rehab">
        <label for="rehabBudget" class="form-label">Rehab Budget</label>
        <input id="rehabBudget" class="form-input" type="number" value="40000" step="1000" />
        <div class="form-hint">Used in profit/ROI estimate</div>
      </div>
      <div class="switches">
        <label><input id="includeMarketData" type="checkbox" /> Show Days on Market</label>
        <label><input id="groupNeighborhoods" type="checkbox" checked /> Group nearby areas</label>
      </div>
      <div class="actions">
        <button id="analyzeBtn" onclick="analyzeNeighborhoods()">üîé Find Best Areas</button>
      </div>
    </div>

    <div id="results" class="banner">
      <div class="loading"><div class="spinner"></div><p>Ready to analyze neighborhoods‚Ä¶</p></div>
    </div>
  </div>

  <script>
    const API_URL = '/api/analyze';
    function b01(v){ return v ? '1' : '0'; }

    async function analyzeNeighborhoods() {
      const resultsDiv = document.getElementById('results');
      const analyzeBtn = document.getElementById('analyzeBtn');

      const minPrice = Number(document.getElementById('minPrice').value || 200000);
      const maxPrice = Number(document.getElementById('maxPrice').value || 225000);
      const rehabBudget = Number(document.getElementById('rehabBudget').value || 40000);
      const includeMarketData = !!document.getElementById('includeMarketData')?.checked;
      const groupNeighborhoods = document.getElementById('groupNeighborhoods')?.checked ?? true;

      analyzeBtn.disabled = true;
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing neighborhoods‚Ä¶</p></div>';

      try {
        const params = new URLSearchParams({
          top: '50',
          min_score: '0',
          price_min: String(minPrice),
          price_max: String(maxPrice),
          rehab_budget: String(rehabBudget),
          marketdata: b01(includeMarketData),
          groupneighborhood: b01(groupNeighborhoods)
        });
        const url = `${API_URL}?${params.toString()}`;
        console.debug('[flip-analyzer] GET', url);

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 60000);
        const res = await fetch(url, { method: 'GET', signal: controller.signal });
        clearTimeout(timer);

        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { /* keep raw */ }

        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || raw || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        if (data && data.status === 'error') {
          throw new Error(data.message || 'API returned an error.');
        }

        displayResults(data, rehabBudget);
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = `<div class="error">
          <h3>‚ö†Ô∏è Error Loading Data</h3>
          <p><strong>Error:</strong> ${err.message || err}</p>
          <p style="margin-top:8px; font-size:12px; color:#475569;">If this persists, check App Insights and verify parameter names.</p>
        </div>`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    function getScoreClass(score){
      if(score>=80) return 'excellent';
      if(score>=70) return 'very-good';
      if(score>=50) return 'good';
      if(score>=30) return 'fair';
      return 'poor';
    }
    function getScoreLabel(score){
      if(score>=80) return 'Excellent';
      if(score>=70) return 'Very Good';
      if(score>=50) return 'Good';
      if(score>=30) return 'Fair';
      return 'Poor';
    }
    function fmtMoney(x){ return (x || x===0) ? ('$'+Number(x).toLocaleString()) : 'N/A'; }
    function fmtPct(x){ return (x!=null) ? (Number(x).toFixed(1)+'%') : 'N/A'; }
    function fmtInt(x){ return x ? Number(x).toLocaleString() : 'N/A'; }

    function getGapChip(r){
      if(!r) return '';
      let cls='chip-gap', label='';
      if(r>=1.25 && r<=1.45){ cls+=' excellent'; label='üéØ Perfect Gap: '+r+'x'; }
      else if(r>=1.15 && r<1.25){ cls+=' good'; label='‚úì Good Gap: '+r+'x'; }
      else if(r<1.15){ cls+=' warning'; label='‚ö† Tight Margin: '+r+'x'; }
      else { cls+=' good'; label='Gap: '+r+'x'; }
      return `<span class="${cls}">${label}</span>`;
    }

    function detailsBlock(title, htmlInner){
      return `<details class="block"><summary>${title}</summary><div class="content">${htmlInner}</div></details>`;
    }

    function displayResults(data, rehabBudget){
      const resultsDiv = document.getElementById('results');
      const grouped = !!data.grouped_by_neighborhood || !!data.neighborhoods;
      const items = grouped ? (data.neighborhoods || []) : (data.opportunities || []);
      if(!items.length){
        resultsDiv.innerHTML = `<div class="empty"><h2>No areas found</h2><p>Try adjusting your budget range.</p></div>`;
        return;
      }

      const band = data.price_band_used ? `$${Number(data.price_band_used.min).toLocaleString()}‚Äì$${Number(data.price_band_used.max).toLocaleString()}` : null;
      let html = `<div class="summary">
        <div class="summary-item"><div class="summary-label">Tracts Analyzed</div><div class="summary-value">${data.total_tracts_analyzed||0}</div></div>
        <div class="summary-item"><div class="summary-label">Areas Found</div><div class="summary-value">${data.summary?.total_meeting_criteria||0}</div></div>
        <div class="summary-item"><div class="summary-label">Best Score</div><div class="summary-value">${data.summary?.top_score||0}/100</div></div>
        <div class="summary-item"><div class="summary-label">Average Score</div><div class="summary-value">${data.summary?.avg_score||0}/100</div></div>
        ${band ? `<div class="summary-item"><div class="summary-label">Your Purchase Budget</div><div class="summary-value">${band}</div></div>` : ''}
      </div>
      <div class="results">`;

      items.forEach((item, idx) => {
        const score = item.score || 0;
        const scoreClass = getScoreClass(score);
        const scoreLabel = getScoreLabel(score);

        const title = `${idx+1}. ${item.neighborhood || 'Neighborhood'}`;
        const subtitle = [
          item.county_name ? `${item.county_name} County` : null,
          grouped && item.tracts_count!=null ? `${item.tracts_count} areas combined` : null
        ].filter(Boolean).join(' ‚Ä¢ ');

        const chips = [];
        if(item.gap_ratio) chips.push(getGapChip(item.gap_ratio));
        if(grouped && item.zip_guess && !item.zip_code){
          const conf = item.zip_confidence!=null ? ` (${Math.round(item.zip_confidence*100)}% match)` : '';
          chips.push(`<span class="chip-zip">ZIP: ${item.zip_guess}${conf}</span>`);
        }
        if(grouped && item.label_hint) chips.push(`<span class="chip-hint">${item.label_hint}</span>`);
        const helpersRow = chips.length ? `<div class="chips">${chips.join('')}</div>` : '';

        /* Keep the always-visible part SMALL: median home value + maybe DOM */
        const domRow = (item.days_on_market!=null)
          ? `<div class="info-row"><span class="info-label">Avg. Days on Market</span><span class="info-value">${item.days_on_market} days</span></div>`
          : '';
        const baseRows = `
          <div class="info-row"><span class="info-label">Median Home Value</span><span class="info-value">${fmtMoney(item.median_home_value)}</span></div>
          ${domRow}
        `;

        /* Collapsible sections */
        let flipCalc = '';
        if(item.median_home_value && item.gap_ratio){
          const purchaseEst = Math.round(item.median_home_value / item.gap_ratio);
          const sellEst = item.median_home_value;
          const profitEst = sellEst - purchaseEst - rehabBudget;
          const roiEst = ((profitEst / (purchaseEst + rehabBudget)) * 100).toFixed(1);
          flipCalc = detailsBlock('üíµ Estimated Flip Potential',
            `Buy distressed: <strong>~${fmtMoney(purchaseEst)}</strong><br>
             Rehab budget: <strong>~${fmtMoney(rehabBudget)}</strong><br>
             Sell at median: <strong>${fmtMoney(sellEst)}</strong><br>
             Est. Profit: <strong style="color:${profitEst>0? 'var(--ok)':'var(--warn)'}">${fmtMoney(profitEst)}</strong> (${roiEst}% ROI)`
          );
        }

        let whySection = '';
        const insights = item.insights || [];
        const warnings = item.warnings || [];
        if (insights.length || warnings.length) {
          let list = '';
          insights.forEach(s => list += `<li>‚úì ${s}</li>`);
          warnings.forEach(w => list += `<li>! ${w}</li>`);
          whySection = detailsBlock('üí° Why This Area', `<ul class="bullets">${list}</ul>`);
        }

        const members = (grouped && item.member_tracts?.length)
          ? detailsBlock('üß© Included census tracts',
              `${item.member_tracts.slice(0,12).map(m=>m.tract_id).join(', ')}${item.member_tracts.length>12?'‚Ä¶':''}`)
          : '';

        html += `<div class="tract-card">
          <div class="score-badge ${scoreClass}"><div>${score}</div><div class="score-label">${scoreLabel}</div></div>
          <div class="tract-title">${title}</div>
          <div class="tract-sub">${subtitle}</div>
          ${helpersRow}
          <div class="tract-info">${baseRows}</div>
          ${flipCalc}
          ${whySection}
          ${members}
        </div>`;
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    // Run once on load
    window.addEventListener('load', () => setTimeout(() => analyzeNeighborhoods(), 200));
  </script>
</body>
</html>
