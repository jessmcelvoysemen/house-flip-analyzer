<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PajeClip House Flip Analyzer</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header { background:#fff; padding:30px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1); margin-bottom:30px; }
    h1 { color:#2d3748; font-size:32px; margin-bottom:10px; }
    .subtitle { color:#718096; font-size:16px; margin-bottom:20px; }
    .controls { display:flex; gap:15px; flex-wrap:wrap; align-items:end; }
    .control-group { display:flex; flex-direction:column; gap:5px; }
    label { font-size:14px; font-weight:600; color:#4a5568; }
    input, select { padding:10px 15px; border:2px solid #e2e8f0; border-radius:6px; font-size:14px; transition:all .2s; }
    input:focus, select:focus { outline:none; border-color:#667eea; }
    button {
      padding:12px 30px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; border:none; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer;
      transition: transform .2s, box-shadow .2s;
    }
    button:hover { transform: translateY(-2px); box-shadow:0 4px 12px rgba(102,126,234,.4); }
    button:active { transform:translateY(0); }
    button:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .loading { text-align:center; padding:40px; background:#fff; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .spinner { border:4px solid #f3f4f6; border-top:4px solid #667eea; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 20px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .summary { background:#fff; padding:25px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1); margin-bottom:20px; display:flex; gap:30px; flex-wrap:wrap; }
    .summary-item { flex:1; min-width:150px; }
    .summary-label { font-size:14px; color:#718096; margin-bottom:5px; }
    .summary-value { font-size:22px; font-weight:700; color:#2d3748; }
    .results { display:grid; grid-template-columns: repeat(auto-fill, minmax(350px,1fr)); gap:20px; }
    .tract-card { background:#fff; border-radius:12px; padding:25px; box-shadow:0 4px 6px rgba(0,0,0,.1); transition: transform .2s, box-shadow .2s; position:relative; overflow:hidden; }
    .tract-card:hover { transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,.15); }
    .score-badge { position:absolute; top:20px; right:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:10px 15px; border-radius:8px; font-weight:700; font-size:20px; }
    .tract-title { font-size:18px; font-weight:700; color:#2d3748; margin-bottom:6px; padding-right:80px; }
    .tract-sub { font-size:12px; color:#a0aec0; margin-bottom:8px; }
    .chips { margin:8px 0 2px 0; display:flex; gap:8px; flex-wrap:wrap; }
    .chip-zip { display:inline-block;background:#ebf4ff;color:#2b6cb0;border:1px solid #90cdf4;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600; }
    .chip-hint{ display:inline-block;background:#f7fafc;color:#4a5568;border:1px solid #e2e8f0;padding:2px 8px;border-radius:999px;font-size:12px; }
    .tract-info { display:grid; gap:10px; margin-bottom:15px; padding-bottom:15px; border-bottom:2px solid #f7fafc; }
    .info-row { display:flex; justify-content:space-between; font-size:14px; }
    .info-label { color:#718096; font-weight:500; }
    .info-value { color:#2d3748; font-weight:600; }
    .reasons { margin-top:15px; }
    .reasons-title { font-size:13px; font-weight:600; color:#4a5568; margin-bottom:8px; }
    .reason { font-size:13px; color:#4a5568; padding:5px 0; line-height:1.4; }
    .flag { display:inline-block; background:#fed7d7; color:#c53030; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600; margin-left:5px; }
    .error { background:#fff5f5; border:2px solid #fc8181; color:#c53030; padding:20px; border-radius:12px; margin-bottom:20px; }
    .empty { background:#fff; padding:60px 40px; border-radius:12px; text-align:center; color:#718096; font-size:18px; }
    small.hint { color:#718096; font-size:12px; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    @media (max-width:768px){ .results{grid-template-columns:1fr} .controls{flex-direction:column; align-items:stretch} button{width:100%} }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üè† PajeClip House Flip Analyzer</h1>
    <p class="subtitle">Find the best neighborhoods for our budget to fix-and-flip</p>

    <div class="controls">
      <div class="control-group">
        <label for="topResults">Show Top Results</label>
        <select id="topResults">
          <option value="10">Top 10</option>
          <option value="25" selected>Top 25</option>
          <option value="50">Top 50</option>
          <option value="100">Top 100</option>
        </select>
      </div>

      <div class="control-group">
        <label for="minScore">Minimum Score</label>
        <select id="minScore">
          <option value="0">All Results</option>
          <option value="50" selected>50+ (Good)</option>
          <option value="70">70+ (Very Good)</option>
          <option value="80">80+ (Excellent)</option>
        </select>
      </div>

      <div class="control-group">
        <label for="minPrice">Min Budget</label>
        <input id="minPrice" type="number" value="200000" min="0" step="5000" />
      </div>

      <div class="control-group">
        <label for="maxPrice">Max Budget</label>
        <input id="maxPrice" type="number" value="225000" min="0" step="5000" />
      </div>

      <div class="control-group">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="includeMarketData" style="width:auto; cursor:pointer;" checked>
          <span>Include Days on Market</span>
        </label>
        <small class="hint">Uses API quota</small>
      </div>

      <div class="control-group">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="groupNeighborhoods" style="width:auto; cursor:pointer;" checked>
          <span>Group similar neighborhoods</span>
        </label>
        <small class="hint">Aggregates tracts by area</small>
      </div>

      <button id="analyzeBtn" onclick="analyzeNeighborhoods()">üîç Analyze Neighborhoods</button>
    </div>
  </header>

  <div id="results"></div>
</div>

<script>
  const API_URL = 'http://localhost:7071/api/analyze';

  async function analyzeNeighborhoods() {
    const resultsDiv = document.getElementById('results');
    const analyzeBtn = document.getElementById('analyzeBtn');

    const topResults = document.getElementById('topResults').value;
    const minScore = document.getElementById('minScore').value;
    const minPrice = document.getElementById('minPrice').value || '200000';
    const maxPrice = document.getElementById('maxPrice').value || '225000';
    const includeMarketData = document.getElementById('includeMarketData').checked;
    const groupNeighborhoods = document.getElementById('groupNeighborhoods').checked;

    analyzeBtn.disabled = true;
    resultsDiv.innerHTML =
      '<div class="loading">' +
        '<div class="spinner"></div>' +
        '<p>Analyzing census data across Central Indiana...</p>' +
        (includeMarketData ? '<p class="hint" style="margin-top:10px;">Fetching real-time market data‚Ä¶</p>' : '') +
        (groupNeighborhoods ? '<p class="hint" style="margin-top:6px;">Aggregating similar neighborhoods‚Ä¶</p>' : '') +
      '</div>';

    try {
      let url = API_URL
        + '?top=' + encodeURIComponent(topResults)
        + '&min_score=' + encodeURIComponent(minScore)
        + '&price_min=' + encodeURIComponent(minPrice)
        + '&price_max=' + encodeURIComponent(maxPrice);

      if (includeMarketData) url += '&market_data=true';
      if (groupNeighborhoods) url += '&group=neighborhood';

      const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' }});
      if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);

      const data = await response.json();
      if (data.status === 'error') throw new Error(data.message);

      displayResults(data);
    } catch (err) {
      console.error(err);
      resultsDiv.innerHTML =
        '<div class="error">' +
          '<h3 style="margin-bottom:10px;">‚ö†Ô∏è Error Loading Data</h3>' +
          '<p><strong>Error:</strong> ' + (err.message || err) + '</p>' +
          '<p style="margin-top:15px; font-size:14px;">' +
            '<strong>Troubleshooting:</strong><br>' +
            '1) Ensure the Azure Function is running<br>' +
            '2) Confirm API_URL matches your function URL<br>' +
            '3) Verify CORS allows this origin<br>' +
            '4) Hard-refresh the page to clear cache' +
          '</p>' +
        '</div>';
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  function displayResults(data) {
    const resultsDiv = document.getElementById('results');
    const grouped = Boolean(data.grouped_by_neighborhood) || !!data.neighborhoods;

    const items = grouped ? (data.neighborhoods || []) : (data.opportunities || []);
    if (!items.length) {
      resultsDiv.innerHTML =
        '<div class="empty">' +
          '<h2>No ' + (grouped ? 'neighborhoods' : 'opportunities') + ' found matching your criteria</h2>' +
          '<p style="margin-top:10px;">Try lowering the minimum score filter</p>' +
        '</div>';
      return;
    }

    let html = '';

    // Summary
    var band = (data.price_band_used && data.price_band_used.min != null)
      ? ('$' + Number(data.price_band_used.min).toLocaleString() + '‚Äì$' + Number(data.price_band_used.max).toLocaleString())
      : null;

    html +=
      '<div class="summary">' +
        '<div class="summary-item">' +
          '<div class="summary-label">Tracts Analyzed</div>' +
          '<div class="summary-value">' + (data.total_tracts_analyzed || 0) + '</div>' +
        '</div>' +
        '<div class="summary-item">' +
          '<div class="summary-label">' + (grouped ? 'Areas Found' : 'Opportunities Found') + '</div>' +
          '<div class="summary-value">' + (data.summary.total_meeting_criteria || 0) + '</div>' +
        '</div>' +
        '<div class="summary-item">' +
          '<div class="summary-label">Top Score</div>' +
          '<div class="summary-value">' + (data.summary.top_score || 0) + '/100</div>' +
        '</div>' +
        '<div class="summary-item">' +
          '<div class="summary-label">Average Score</div>' +
          '<div class="summary-value">' + (data.summary.avg_score || 0) + '/100</div>' +
        '</div>' +
        (band ? (
          '<div class="summary-item">' +
            '<div class="summary-label">Budget Band Used</div>' +
            '<div class="summary-value">' + band + '</div>' +
          '</div>'
        ) : '') +
      '</div>';

    html += '<div class="results">';

    items.forEach(function(item, idx) {
      const flags = item.flags || [];
      const flagsHtml = flags.map(function(f){
        return '<span class="flag">' + String(f).replace(/_/g,' ') + '</span>';
      }).join('');

      // Title upgrading for Subareas with zip_guess
      var nameForTitle = item.neighborhood || 'Neighborhood';
      if (grouped && /‚Äì\s*Subarea$/i.test(nameForTitle) && item.zip_guess) {
        nameForTitle = nameForTitle.replace(/‚Äì\s*Subarea$/i, '‚Äì ' + item.zip_guess);
      }
      var title = (idx + 1) + '. ' + nameForTitle;

      var subParts = [];
      if (item.county_name) subParts.push(item.county_name + ' County');
      if (grouped && item.tracts_count != null) subParts.push(item.tracts_count + ' tracts combined');
      var subtitle = subParts.join(' ‚Ä¢ ');

      // Chips: zip guess / hint
      var helpersRow = '';
      if (grouped && (item.zip_guess || item.label_hint)) {
        var chips = [];
        if (item.zip_guess && !item.zip_code) {
          var conf = (item.zip_confidence != null) ? ' (' + Math.round(item.zip_confidence*100) + '%)' : '';
          chips.push('<span class="chip-zip">ZIP guess: ' + item.zip_guess + conf + '</span>');
        }
        if (item.label_hint) chips.push('<span class="chip-hint">' + item.label_hint + '</span>');
        if (chips.length) helpersRow = '<div class="chips">' + chips.join('') + '</div>';
      }

      function fmtMoney(x){ return x ? ('$' + Number(x).toLocaleString()) : 'N/A'; }
      function fmtPct(x){ return (x != null) ? (Number(x).toFixed(1) + '%') : 'N/A'; }
      function fmtInt(x){ return x ? Number(x).toLocaleString() : 'N/A'; }

      var domRow = '';
      if (item.days_on_market) {
        domRow =
          '<div class="info-row" style="border-top:2px solid #e2e8f0; padding-top:10px; margin-top:10px;">' +
            '<span class="info-label">üìä Days on Market</span>' +
            '<span class="info-value" style="color:#667eea; font-weight:700;">' + item.days_on_market + ' days</span>' +
          '</div>';
      }

      var baseRows =
        '<div class="info-row">' +
          '<span class="info-label">Median Home Value</span>' +
          '<span class="info-value">' + fmtMoney(item.median_home_value) + '</span>' +
        '</div>' +
        '<div class="info-row">' +
          '<span class="info-label">Median Income</span>' +
          '<span class="info-value">' + fmtMoney(item.median_income) + '</span>' +
        '</div>' +
        '<div class="info-row">' +
          '<span class="info-label">Vacancy Rate</span>' +
          '<span class="info-value">' + fmtPct(item.vacancy_pct) + '</span>' +
        '</div>' +
        '<div class="info-row">' +
          '<span class="info-label">' + (grouped ? 'Combined Population' : 'Population') + '</span>' +
          '<span class="info-value">' + fmtInt(item.total_pop) + '</span>' +
        '</div>' +
        (grouped ? '' :
          ('<div class="info-row">' +
             '<span class="info-label">Housing Units</span>' +
             '<span class="info-value">' + fmtInt(item.housing_units) + '</span>' +
           '</div>')
        ) +
        domRow;

      html +=
        '<div class="tract-card">' +
          '<div class="score-badge">' + (item.score != null ? item.score : '‚Äî') + '/100</div>' +
          '<div class="tract-title">' + title + '</div>' +
          '<div class="tract-sub">' + subtitle + '</div>' +
          helpersRow +
          '<div class="tract-info">' + baseRows + '</div>' +
          (flagsHtml ? ('<div style="margin-bottom:10px;">' + flagsHtml + '</div>') : '') +
          (grouped && item.member_tracts && item.member_tracts.length ?
            ('<div class="reasons" style="margin-top:6px;">' +
               '<div class="reasons-title">Included Tracts:</div>' +
               '<div class="reason" style="color:#718096;">' +
                 item.member_tracts.slice(0,6).map(function(m){return m.tract_id;}).join(', ') +
                 (item.member_tracts.length > 6 ? '‚Ä¶' : '') +
               '</div>' +
             '</div>')
           : ''
          ) +
          (!grouped && item.reasons ?
            ('<div class="reasons">' +
               '<div class="reasons-title">Why This Area:</div>' +
               item.reasons.map(function(r){ return '<div class="reason">‚Ä¢ ' + r + '</div>'; }).join('') +
             '</div>')
           : ''
          ) +
        '</div>';
    });

    html += '</div>';
    resultsDiv.innerHTML = html;
  }

  // Optional: auto-run on load
  // window.addEventListener('load', analyzeNeighborhoods);
</script>
</body>
</html>
