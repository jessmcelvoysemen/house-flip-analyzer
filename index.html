<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Finder</title>
  <style>
    :root {
      --bg1: #6a11cb;
      --bg2: #2575fc;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --ok: #16a34a;
      --warn: #dc2626;
      --chip: #eef2ff;
      --border: #e5e7eb;
      --shadow: 0 8px 30px rgba(0,0,0,.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg2)) fixed;
      min-height: 100vh;
    }
    .container { max-width: 1060px; margin: 32px auto; padding: 0 16px; }

    .header { background: #fff; border-radius: 16px; padding: 18px 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; }
    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 2px 0 0; color: var(--muted); }

    .explain { margin-top: 16px; background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; border-radius: 14px; padding: 16px; }
    .explain h3 { margin: 0 0 8px; font-size: 16px; }
    .explain .grid { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 10px; }
    .tile { background: #fff; border-radius: 10px; padding: 10px; border: 1px solid #fde68a; }

    .controls {
      margin-top: 18px; background:#fff; border-radius:16px; padding:16px; box-shadow: var(--shadow);
      display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items:end;
    }
    .form-group { grid-column: span 3; }
    .form-group.rehab { grid-column: span 3; }
    .form-label { display:block; font-size: 12px; color: #334155; margin-bottom: 6px; }
    .form-input { width: 100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; }
    .form-hint { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .switches { grid-column: span 4; display:flex; gap:16px; align-items:center; }
    .switches label { display:flex; gap:8px; align-items:center; font-size: 14px; color:#334155; }
    .actions { grid-column: span 2; justify-self:end; }
    #analyzeBtn { width: 100%; background:#4f46e5; color:#fff; border:none; border-radius:12px; padding:12px 14px; font-weight:600; cursor:pointer; }
    #analyzeBtn:disabled { opacity:.6; cursor:not-allowed; }

    .banner { margin-top:16px; padding:14px; border-radius:14px; background:#fff; }
    .loading { display:flex; gap:12px; align-items:center; }
    .spinner { width:18px; height:18px; border:3px solid #e5e7eb; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .summary { margin-top:18px; display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; }
    .summary-item { background:#ffffff; border-radius:12px; padding:12px; box-shadow: var(--shadow); text-align:center;}
    .summary-label { color:var(--muted); font-size:12px; }
    .summary-value { font-size:18px; font-weight:700; margin-top:4px; }

    .results { margin-top:14px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; }
    .tract-card { position:relative; background:#ffffff; border-radius:16px; padding:14px; box-shadow: var(--shadow); }
    .score-badge { position:absolute; top:-10px; right:-10px; width:62px; height:62px; border-radius:50%; background:#e5e7eb; color:#111827; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:800; }
    .score-badge .score-label { font-weight:700; font-size:10px; margin-top:2px; }
    .score-badge.excellent { background:#dcfce7; }
    .score-badge.very-good { background:#e0f2fe; }
    .score-badge.good { background:#fef9c3; }
    .score-badge.fair { background:#fee2e2; }

    .tract-title { font-weight:800; font-size:18px; padding-right:74px; }
    .tract-sub { color:var(--muted); font-size:12px; margin-top:4px; }

    .chips { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .chip-gap, .chip-zip, .chip-hint { background:var(--chip); color:#3730a3; border-radius:999px; padding:4px 8px; font-size:12px; border:1px solid #e0e7ff; }
    .chip-gap.excellent { background:#dcfce7; color:#065f46; border-color:#bbf7d0; }
    .chip-gap.warning { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }

    .tract-info { margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:14px; }
    .info-row { display:flex; justify-content:space-between; }
    .info-label { color:#475569; }
    .info-value { font-weight:700; }

    details.block { border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; margin-top:10px; }
    details.block + details.block { margin-top:8px; }
    details.block > summary { list-style:none; cursor:pointer; font-weight:700; }
    details.block > summary::-webkit-details-marker { display:none; }
    details.block[open] > summary { color:#4f46e5; }
    details .content { margin-top:8px; font-size:14px; }
    details .bullets { padding-left:18px; margin:8px 0 0; }

    .error { background:#fff1f2; border:1px solid #fecdd3; color:#7f1d1d; border-radius:12px; padding:14px; }
    .empty { background:#ffffff; border-radius:12px; padding:16px; text-align:center; }

    .listings { display:grid; grid-template-columns: 1fr; gap:8px; }
    .listing { border:1px solid var(--border); border-radius:10px; padding:8px 10px; display:flex; gap:10px; align-items:center; }
    .listing img { width:64px; height:48px; object-fit:cover; border-radius:8px; background:#f1f5f9; }
    .listing a { text-decoration:none; color:#2563eb; }

    @keyframes shimmer { 0% { opacity:.6 } 50% { opacity:1 } 100% { opacity:.6 } }
    .ghost { animation: shimmer 1.4s infinite; background:#f3f4f6; height:14px; border-radius:6px; }

    @media (max-width: 900px) {
      .summary { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .results { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
      .form-group, .form-group.rehab, .switches, .actions { grid-column: 1 / -1; }
      .actions { justify-self: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="font-size:28px">üè†</div>
      <div>
        <h1>Flip Finder</h1>
        <p>Data-driven insights for house flipping opportunities in Central Indiana</p>
      </div>
    </div>

    <div class="explain">
      <h3>üßÆ How We Score Each Neighborhood (0‚Äì100 points)</h3>
      <p style="margin:8px 0; color:#475569;">Each area gets a score based on how good it is for flipping houses. Higher scores = better opportunities.</p>

      <div class="grid">
        <div class="tile"><strong>üí∞ Profit Potential</strong><br/>Are home values high enough above your budget to make money?<br/><span style="color:#6b7280; font-size:13px;">Worth 50 points</span></div>
        <div class="tile"><strong>üèöÔ∏è Available Homes</strong><br/>Are there enough fixer-uppers to choose from?<br/><span style="color:#6b7280; font-size:13px;">Worth 20 points</span></div>
        <div class="tile"><strong>üë• Buyer Income</strong><br/>Can people afford to buy your fixed-up house?<br/><span style="color:#6b7280; font-size:13px;">Worth 20 points</span></div>
        <div class="tile"><strong>‚ö° Selling Speed</strong><br/>How quickly do houses sell in this area?<br/><span style="color:#6b7280; font-size:13px;">Worth 10 points</span></div>
      </div>

      <div style="margin-top:12px; padding:12px; background:#fff; border-radius:10px; border:1px solid #fed7aa;">
        <strong>üéØ Bonus Points (Great schools and new businesses add extra value!):</strong><br/>
        <div style="margin-top:6px; font-size:14px; line-height:1.6;">
          ‚Ä¢ <strong>üéì Excellent schools (8-10 rating):</strong> +5 points ‚Äî Families will pay more for good schools<br/>
          ‚Ä¢ <strong>üéì Good schools (7-8 rating):</strong> +3 points ‚Äî Nice advantage for resale<br/>
          ‚Ä¢ <strong>‚≠ê New Starbucks nearby:</strong> +3 points ‚Äî Sign of growing neighborhood<br/>
          ‚Ä¢ <strong>‚ö†Ô∏è Poor schools (below 5):</strong> -2 points ‚Äî Harder to sell to families
        </div>
      </div>

      <div style="margin-top:10px; padding:10px; background:#e0f2fe; border-radius:10px; font-size:14px;">
        <strong>üí° What's a good score?</strong> 75+ = Hot market ¬∑ 60-74 = Solid choice ¬∑ 45-59 = Worth considering ¬∑ Below 45 = Risky
      </div>
    </div>

    <div class="controls">
      <div class="form-group">
        <label for="minPrice" class="form-label">Min Purchase Price</label>
        <input id="minPrice" class="form-input" type="number" value="150000" step="5000" />
      </div>
      <div class="form-group">
        <label for="maxPrice" class="form-label">Max Purchase Price</label>
        <input id="maxPrice" class="form-input" type="number" value="250000" step="5000" />
      </div>
      <div class="form-group rehab">
        <label for="rehabBudget" class="form-label">Rehab Budget</label>
        <input id="rehabBudget" class="form-input" type="number" value="40000" step="1000" />
        <div class="form-hint">Used in profit/ROI estimate</div>
      </div>
      <div class="switches">
        <label><input id="includeMarketData" type="checkbox" /> Show Days on Market</label>
        <label><input id="groupNeighborhoods" type="checkbox" checked /> Group nearby areas</label>
      </div>
      <div class="actions">
        <button id="analyzeBtn" onclick="analyzeNeighborhoods()">üîç Analyze Opportunities</button>
      </div>
    </div>

    <div id="results" class="banner">
      <div class="loading"><div class="spinner"></div><p>Configure your search parameters above, then click Analyze</p></div>
    </div>
  </div>

  <script>
    const API_URL = '/api/analyze';
    const LIST_URL = '/api/listings';
    function b01(v){ return v ? '1' : '0'; }
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function analyzeNeighborhoods() {
      const resultsDiv = document.getElementById('results');
      const analyzeBtn = document.getElementById('analyzeBtn');

      const minPrice = Number(document.getElementById('minPrice').value || 150000);
      const maxPrice = Number(document.getElementById('maxPrice').value || 250000);
      const rehabBudget = Number(document.getElementById('rehabBudget').value || 40000);
      const includeMarketData = !!(document.getElementById('includeMarketData') && document.getElementById('includeMarketData').checked);
      const groupNeighborhoods = (document.getElementById('groupNeighborhoods') && document.getElementById('groupNeighborhoods').checked) ? 1 : 0;

      analyzeBtn.disabled = true;
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing neighborhoods and market data...</p></div>';

      const targetRangeMin = Math.round(maxPrice * 1.1);
      const targetRangeMax = Math.round(maxPrice * 1.6);
      console.log('üîç Starting analysis with params:', {
        budget: `$${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()}`,
        targetMedianRange: `$${targetRangeMin.toLocaleString()} - $${targetRangeMax.toLocaleString()}`,
        rehabBudget: `$${rehabBudget.toLocaleString()}`,
        includeMarketData,
        groupNeighborhoods
      });

      try {
        const params = new URLSearchParams({
          top: '50',
          min_score: '0',  // Show all areas (we'll investigate the "only 9" issue separately)
          price_min: String(minPrice),
          price_max: String(maxPrice),
          rehab_budget: String(rehabBudget),
          include_market_data: b01(includeMarketData),
          groupneighborhood: String(groupNeighborhoods)
        });
        const url = API_URL + '?' + params.toString();

        // Longer timeout when fetching market data (RapidAPI calls take time)
        const timeoutMs = includeMarketData ? 180000 : 90000;

        // Use fetch with timeout, but handle aborts gracefully
        let res;
        try {
          const controller = new AbortController();
          const timer = setTimeout(function(){
            console.warn('Request timeout after ' + (timeoutMs/1000) + ' seconds');
            controller.abort();
          }, timeoutMs);

          res = await fetch(url, {
            method: 'GET',
            signal: controller.signal,
            headers: { 'Accept': 'application/json' }
          });
          clearTimeout(timer);
        } catch (fetchError) {
          if (fetchError.name === 'AbortError') {
            const timeoutSec = Math.round(timeoutMs / 1000);
            throw new Error(`Request timed out after ${timeoutSec} seconds. The analysis is processing a large area. ${includeMarketData ? 'Try without "Show Days on Market" for faster results, or' : ''} try narrowing your price range.`);
          }
          throw fetchError;
        }

        if (!res.ok) {
          const errorText = await res.text();
          const statusCode = res.status;
          let errorMsg = 'HTTP ' + statusCode;
          try {
            const errorData = JSON.parse(errorText);
            errorMsg = (errorData.error || errorData.message) || errorMsg;
          } catch (e) {
            errorMsg = errorText || errorMsg;
          }
          const err = new Error(errorMsg);
          err.statusCode = statusCode;
          throw err;
        }

        const raw = await res.text();
        let data;
        try {
          data = JSON.parse(raw);
          console.log('‚úÖ Received data successfully:', {
            status: data.status,
            neighborhoods: data.neighborhoods ? data.neighborhoods.length : 0,
            opportunities: data.opportunities ? data.opportunities.length : 0,
            market_data_enabled: data.market_data_enabled
          });
        } catch (parseError) {
          console.error('‚ùå JSON parse error:', parseError, 'Raw response:', raw.substring(0, 200));
          throw new Error('Invalid response from server. Check console for details.');
        }

        if (data && data.status === 'error') {
          throw new Error(data.message || 'API returned an error.');
        }

        await sleep(600); // "thinking" moment
        displayResults(data, rehabBudget, maxPrice);
      } catch (err) {
        console.error(err);

        // Smart handling for rate limit errors (must be explicit, not just any 500 error)
        const isRateLimitError = includeMarketData && (
          err.statusCode === 429 ||
          (err.message && (err.message.includes('429') || err.message.toLowerCase().includes('rate limit') || err.message.toLowerCase().includes('daily limit')))
        );

        if (isRateLimitError) {
          resultsDiv.innerHTML = '<div class="error">'
            + '<h3>üè† Days on Market Temporarily Unavailable</h3>'
            + '<p>The free connection to Realtor.com that calculates Days on Market has hit its daily limit.</p>'
            + '<p style="margin-top:12px;"><strong>No worries!</strong> You can:</p>'
            + '<ul style="margin:8px 0; padding-left:20px;">'
            + '<li>Search without Days on Market (it\'ll just exclude DOM from the calculation)</li>'
            + '<li>Try again tomorrow when the limit resets</li>'
            + '</ul>'
            + '<button onclick="document.getElementById(\'includeMarketData\').checked=false; document.getElementById(\'analyzeBtn\').click();" '
            + 'style="background:#6366f1; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:8px;">'
            + 'üîÑ Search Without Days on Market'
            + '</button>'
            + '</div>';
        } else {
          resultsDiv.innerHTML = '<div class="error">'
            + '<h3>‚ö†Ô∏è Error Loading Data</h3>'
            + '<p><strong>Error:</strong> ' + (err.message || err) + '</p>'
            + '<p style="margin-top:8px; font-size:12px; color:#475569;">Please try again or adjust your search parameters.</p>'
            + '</div>';
        }
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    function getScoreClass(score){
      if(score>=75) return 'excellent';
      if(score>=60) return 'very-good';
      if(score>=45) return 'good';
      if(score>=30) return 'fair';
      return 'poor';
    }
    function getScoreLabel(score){
      if(score>=75) return 'üî• Hot!';      // 75+ = A grade
      if(score>=60) return 'Solid';        // 60-74 = B grade
      if(score>=45) return 'Worth It';     // 45-59 = C grade
      if(score>=30) return 'Meh';          // 30-44 = D grade
      return 'Skip It';                     // <30 = F grade
    }
    function fmtMoney(x){ return (x || x===0) ? ('$'+Number(x).toLocaleString()) : 'N/A'; }

    function getGapChip(r){
      if(!r) return '';
      var cls='chip-gap', label='';
      if(r>=1.25 && r<=1.45){ cls+=' excellent'; label='üéØ Perfect Gap: '+r+'x'; }
      else if(r>=1.15 && r<1.25){ cls+=' good'; label='‚úì Good Gap: '+r+'x'; }
      else if(r<1.15){ cls+=' warning'; label='‚ö† Tight Margin: '+r+'x'; }
      else { cls+=' good'; label='Gap: '+r+'x'; }
      return '<span class="'+cls+'">'+label+'</span>';
    }

    function detailsBlock(title, htmlInner, extraAttrs){
      extraAttrs = extraAttrs || '';
      return '<details class="block" '+extraAttrs+'><summary>'+title+'</summary><div class="content">'+htmlInner+'</div></details>';
    }

    // Lazy-load listings for a ZIP into a target element id
    var _loadedZip = new Set();
    async function loadListingsOnce(zip, targetId, priceMax, arv, discount){
      discount = (typeof discount === 'number') ? discount : 0.77;
      if(!zip || _loadedZip.has(targetId)) return;
      var target = document.getElementById(targetId);
      if(!target) return;
      _loadedZip.add(targetId);
      target.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading listings for '+zip+'‚Ä¶</p></div>';
      try{
        var q = new URLSearchParams({ zip: zip, limit: '12' });
        if(priceMax) q.set('price_max', String(priceMax));
        if(arv) q.set('arv', String(arv));
        q.set('discount', String(discount));

        const res = await fetch(LIST_URL + '?' + q.toString());
        const data = await res.json();

        // Check for rate limit
        if (data.status === 'rate_limit') {
          target.innerHTML = '<div class="error" style="padding:12px; font-size:14px;">'
            + '<strong>üè† Listings Temporarily Unavailable</strong><br/>'
            + '<span style="color:#475569;">The free connection to Realtor.com has hit its daily limit. Try again tomorrow!</span>'
            + '</div>';
          return;
        }

        const c = data.counts || {};
        var head = '<div style="margin-bottom:8px;color:#475569">'
          + 'Supply: <strong>'+(c.active_total||0)+'</strong> active ¬∑ '
          + '‚â§ budget: <strong>'+(c.under_budget||0)+'</strong> ¬∑ '
          + 'in target band: <strong>'+(c.in_target_band||0)+'</strong>'
          + '</div>';

        const items = (data.results||[]).map(function(r){
          var price = fmtMoney(r.price);
          var beds = (r.beds!=null ? r.beds : '‚Äì');
          var baths = (r.baths!=null ? r.baths : '‚Äì');
          var dom = (r.dom!=null ? (r.dom+' DOM') : '');
          var addr = (r.address || '') + (r.zip ? (' ‚Ä¢ '+r.zip) : '');
          var photo = r.photo || '';
          var link = r.url ? '<a href="'+r.url+'" target="_blank" rel="noopener">View listing</a>' : '';
          return '<div class="listing">'
            + '<img src="'+photo+'" alt="" />'
            + '<div>'
            +   '<div><strong>'+price+'</strong> ‚Äî '+beds+' bd / '+baths+' ba ¬∑ '+dom+'</div>'
            +   '<div style="color:#475569">'+addr+'</div>'
            +   link
            + '</div>'
            + '</div>';
        }).join('');

        target.innerHTML = head + '<div class="listings">' + (items || '<div>No listings found right now.</div>') + '</div>';
      }catch(e){
        console.error(e);
        target.innerHTML = '<div class="error"><strong>Couldn‚Äôt load listings.</strong> Please try again later.</div>';
      }
    }

    function displayResults(data, rehabBudget, maxPrice){
      const resultsDiv = document.getElementById('results');
      const grouped = !!data.grouped_by_neighborhood || !!data.neighborhoods;
      const items = grouped ? (data.neighborhoods || []) : (data.opportunities || []);
      if(!items.length){
        resultsDiv.innerHTML = '<div class="empty"><h2>No Results Found</h2><p>Try adjusting your price range or search parameters.</p></div>';
        return;
      }

      const band = data.price_band_used ? ('$'+Number(data.price_band_used.min).toLocaleString()+'‚Äì$'+Number(data.price_band_used.max).toLocaleString()) : null;
      const totalResults = items.length;

      // Check if any items have market data
      const hasMarketData = items.some(item => item.days_on_market != null);

      // Calculate how many are in the target range
      const priceMax = data.price_band_used ? data.price_band_used.max : maxPrice;
      const targetMin = Math.round(priceMax * 1.1);
      const targetMax = Math.round(priceMax * 1.6);
      const inRangeCount = items.filter(item =>
        item.median_home_value >= targetMin && item.median_home_value <= targetMax
      ).length;

      console.log('üìä Results analysis:', {
        totalResults: items.length,
        inTargetRange: inRangeCount,
        outOfRange: items.length - inRangeCount,
        targetRange: `$${targetMin.toLocaleString()} - $${targetMax.toLocaleString()}`,
        topThree: items.slice(0, 3).map(i => ({
          name: i.neighborhood,
          median: `$${(i.median_home_value || 0).toLocaleString()}`,
          score: i.score,
          inRange: i.median_home_value >= targetMin && i.median_home_value <= targetMax ? '‚úì' : '‚úó'
        }))
      });

      console.log('Market data status:', {
        requested: data.market_data_enabled,
        found: hasMarketData,
        sample: items[0]?.days_on_market
      });

      var html = '<div class="summary">'
        + '<div class="summary-item"><div class="summary-label">Tracts Analyzed</div><div class="summary-value">'+(data.total_tracts_analyzed||0)+'</div></div>'
        + '<div class="summary-item"><div class="summary-label">Results Found</div><div class="summary-value">'+ totalResults +'</div></div>'
        + '<div class="summary-item"><div class="summary-label">Top Score</div><div class="summary-value">'+(data.summary && data.summary.top_score || 0)+'/100</div></div>'
        + '<div class="summary-item"><div class="summary-label">Avg Score</div><div class="summary-value">'+(data.summary && data.summary.avg_score || 0)+'/100</div></div>'
        + (band ? '<div class="summary-item"><div class="summary-label">Price Range</div><div class="summary-value">'+band+'</div></div>' : '')
        + '</div>';

      // Show target range for this budget (using variables already calculated above)
      html += '<div style="background:#e0e7ff; border:2px solid #6366f1; border-radius:12px; padding:12px; margin-top:14px; text-align:center;">'
        + '<div style="font-weight:600; margin-bottom:4px;">üéØ Target Median Home Value Range for Your Budget</div>'
        + '<div style="font-size:14px;">Looking for neighborhoods with median values between <strong>'+fmtMoney(targetMin)+'</strong> and <strong>'+fmtMoney(targetMax)+'</strong></div>'
        + '<div style="font-size:12px; color:#475569; margin-top:4px;">This is ~1.1-1.6√ó your max purchase price of '+fmtMoney(priceMax)+'</div>'
        + '</div>';

      // Add market data indicator
      if (data.market_data_enabled) {
        if (hasMarketData) {
          html += '<div style="background:#dcfce7; border:2px solid #16a34a; border-radius:12px; padding:12px; margin-top:14px; text-align:center; font-weight:600;">'
            + '‚ö° Market data enabled - Days on Market shown below where available'
            + '</div>';
        } else {
          html += '<div style="background:#fef3c7; border:2px solid #f59e0b; border-radius:12px; padding:12px; margin-top:14px; text-align:center; font-weight:600;">'
            + '‚ö†Ô∏è Market data requested but not available for these areas'
            + '</div>';
        }
      }

      if (totalResults > 9) {
        html += '<div style="background:#fef3c7; border:2px solid #fbbf24; border-radius:12px; padding:12px; margin-top:14px; text-align:center; font-weight:600;">'
          + 'üìú Showing all <strong>'+totalResults+'</strong> results below ‚Äî scroll down to see them all!'
          + '</div>';
      }

      html += '<div class="results">';

      items.forEach(function(item, idx){
        const score = item.score || 0;
        const scoreClass = getScoreClass(score);
        const scoreLabel = getScoreLabel(score);

        const title = (idx+1)+'. '+(item.neighborhood || 'Neighborhood');
        const subtitleParts = [];
        if(item.county_name) subtitleParts.push(item.county_name + ' County');
        if(grouped && item.tracts_count!=null) subtitleParts.push(item.tracts_count + ' areas combined');
        const subtitle = subtitleParts.join(' ‚Ä¢ ');

        const chips = [];
        if(item.gap_ratio) chips.push(getGapChip(item.gap_ratio));
        const zip = item.zip_code || item.zip_guess || null;
        if(grouped && item.zip_guess && !item.zip_code){
          const conf = (item.zip_confidence!=null ? (' ('+Math.round(item.zip_confidence*100)+'% match)') : '');
          chips.push('<span class="chip-zip">ZIP: '+item.zip_guess+conf+'</span>');
        }
        if(grouped && item.label_hint) chips.push('<span class="chip-hint">'+item.label_hint+'</span>');
        const helpersRow = chips.length ? ('<div class="chips">'+chips.join('')+'</div>') : '';

        // Calculate target range for this budget
        const targetMin = Math.round(maxPrice * 1.1);
        const targetMax = Math.round(maxPrice * 1.6);
        const inRange = item.median_home_value >= targetMin && item.median_home_value <= targetMax;
        const rangeIndicator = inRange
          ? '<span style="color:#16a34a; font-size:11px; margin-left:4px;">‚úì In target range</span>'
          : '<span style="color:#dc2626; font-size:11px; margin-left:4px;">‚ö†Ô∏è Outside range</span>';

        const domRow = (item.days_on_market!=null)
          ? '<div class="info-row" style="background:#e0f2fe; padding:6px; border-radius:6px; margin-top:6px;"><span class="info-label">‚ö° Days on Market</span><span class="info-value" style="color:#0369a1; font-weight:700;">'+item.days_on_market+' days</span></div>'
          : '';

        // School rating row with color coding
        var schoolRow = '';
        if (item.school_rating != null) {
          var schoolColor = '#475569'; // default gray
          var schoolLabel = 'School Rating';
          if (item.school_rating >= 8.0) {
            schoolColor = '#16a34a'; // green - excellent
            schoolLabel = 'üéì School Rating';
          } else if (item.school_rating >= 7.0) {
            schoolColor = '#0369a1'; // blue - good
            schoolLabel = 'üéì School Rating';
          } else if (item.school_rating <= 5.0) {
            schoolColor = '#dc2626'; // red - below average
            schoolLabel = '‚ö†Ô∏è School Rating';
          }
          schoolRow = '<div class="info-row" style="background:'+(item.school_rating >= 7.0 ? '#f0fdf4' : (item.school_rating <= 5.0 ? '#fef2f2' : '#f8fafc'))+'; padding:6px; border-radius:6px; margin-top:6px;"><span class="info-label">'+schoolLabel+'</span><span class="info-value" style="color:'+schoolColor+'; font-weight:700;">'+item.school_rating+'/10</span></div>';
        }

        const baseRows =
          '<div class="info-row"><span class="info-label">Median Home Value</span><span class="info-value">'+fmtMoney(item.median_home_value)+rangeIndicator+'</span></div>'
          + domRow
          + schoolRow;

        var flipCalc = '';
        if(item.median_home_value && item.gap_ratio){
          const purchaseEst = Math.round(item.median_home_value / item.gap_ratio);
          const sellEst = item.median_home_value;
          const profitEst = sellEst - purchaseEst - rehabBudget;
          const roiEst = ((profitEst / (purchaseEst + rehabBudget)) * 100).toFixed(1);
          flipCalc = detailsBlock('üíµ Estimated Flip Potential',
            'Buy distressed: <strong>~'+fmtMoney(purchaseEst)+'</strong><br>'
            + 'Rehab budget: <strong>~'+fmtMoney(rehabBudget)+'</strong><br>'
            + 'Sell at median: <strong>'+fmtMoney(sellEst)+'</strong><br>'
            + 'Est. Profit: <strong style="color:'+(profitEst>0? 'var(--ok)':'var(--warn)')+'">'+fmtMoney(profitEst)+'</strong> ('+roiEst+'% ROI)'
          );
        }

        var whySection = '';
        const insights = item.insights || [];
        const warnings = item.warnings || [];
        if (insights.length || warnings.length) {
          var list = '';
          insights.forEach(function(s){ list += '<li>‚úì '+s+'</li>'; });
          warnings.forEach(function(w){ list += '<li>! '+w+'</li>'; });
          whySection = detailsBlock('üí° Why This Area', '<ul class="bullets">'+list+'</ul>');
        }

        const members = (grouped && item.member_tracts && item.member_tracts.length)
          ? detailsBlock('üß© Included census tracts',
              item.member_tracts.slice(0,12).map(function(m){ return m.tract_id; }).join(', ')
              + (item.member_tracts.length>12 ? '‚Ä¶' : '')
            )
          : '';

        // Listings block (lazy)
        const listId = 'list-'+idx;
        const listingsDetails = zip
          ? detailsBlock('üè† Current listings' + (zip ? (' (ZIP '+zip+')') : ''),
              '<div id="'+listId+'">'
              +  '<div class="ghost" style="width:65%"></div>'
              +  '<div class="ghost" style="width:50%; margin-top:6px"></div>'
              + '</div>'
            )
          : '';

        html += '<div class="tract-card"'
          + (zip ? (' data-zip="'+zip+'" data-listid="'+listId+'" data-arv="'+(item.median_home_value || '')+'"') : '')
          + '>'
          + '<div class="score-badge '+scoreClass+'"><div>'+score+'</div><div class="score-label">'+scoreLabel+'</div></div>'
          + '<div class="tract-title">'+title+'</div>'
          + '<div class="tract-sub">'+subtitle+'</div>'
          + helpersRow
          + '<div class="tract-info">'+baseRows+'</div>'
          + flipCalc
          + whySection
          + members
          + listingsDetails
          + '</div>';
      });

      html += '</div>';
      resultsDiv.innerHTML = html;

      // Attach 'toggle' handlers for listings
      document.querySelectorAll('.tract-card details.block').forEach(function(det){
        const card = det.closest('.tract-card');
        if(!card) return;
        const zip = card.getAttribute('data-zip');
        const listId = card.getAttribute('data-listid');
        const arv = Number(card.getAttribute('data-arv') || 0);
        det.addEventListener('toggle', function(){
          if(det.open && zip && listId && det.querySelector('#'+listId)){
            const maxPrice = Number(document.getElementById('maxPrice').value || 0);
            loadListingsOnce(zip, listId, maxPrice, arv, 0.77);
          }
        });
      });
    }
  </script>
</body>
</html>
